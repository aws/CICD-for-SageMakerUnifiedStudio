name: SMUS Bundle and Deploy (Reusable)

on:
  workflow_call:
    inputs:
      manifest_path:
        description: 'Path to manifest file'
        required: false
        type: string
        default: 'manifest.yaml'
      
      test_target:
        description: 'Test environment target name'
        required: false
        type: string
        default: 'test'
      
      prod_target:
        description: 'Production environment target name'
        required: false
        type: string
        default: 'prod'
      
      python_version:
        description: 'Python version'
        required: false
        type: string
        default: '3.12'
      
      aws_region:
        description: 'AWS region'
        required: false
        type: string
        default: 'us-east-1'
      
      skip_tests:
        description: 'Skip test execution'
        required: false
        type: boolean
        default: false
      
      deploy_to_prod:
        description: 'Deploy to production after test'
        required: false
        type: boolean
        default: true
      
      bundle_from_target:
        description: 'Target to bundle from (default: dev)'
        required: false
        type: string
        default: 'dev'
      
      quicksight_setup_script:
        description: 'Optional path to QuickSight setup script to run before bundling'
        required: false
        type: string
        default: ''
      
      setup_mlflow:
        description: 'Setup MLflow tracking server infrastructure'
        required: false
        type: boolean
        default: false
    
    secrets:
      AWS_ROLE_ARN_DEV:
        description: 'AWS IAM Role ARN for dev account'
        required: true
      AWS_ROLE_ARN_TEST:
        description: 'AWS IAM Role ARN for test account'
        required: true
      AWS_ROLE_ARN_PROD:
        description: 'AWS IAM Role ARN for prod account'
        required: true

permissions:
  id-token: write
  contents: read

jobs:
  bundle:
    name: Bundle Application
    runs-on: ubuntu-latest
    environment: ${{ fromJSON('{"dev":"dev-aws-account","test":"test-aws-account","prod":"prod-aws-account"}')[inputs.bundle_from_target] || 'dev-aws-account' }}
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python_version }}
      
      - name: Install SMUS CLI
        run: |
          
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
      
      - name: Determine AWS Role ARN for bundle source
        id: bundle-role
        run: |
          case "${{ inputs.bundle_from_target }}" in
            dev)
              echo "role-arn=${{ secrets.AWS_ROLE_ARN_DEV }}" >> $GITHUB_OUTPUT
              ;;
            test)
              echo "role-arn=${{ secrets.AWS_ROLE_ARN_TEST }}" >> $GITHUB_OUTPUT
              ;;
            prod)
              echo "role-arn=${{ secrets.AWS_ROLE_ARN_PROD }}" >> $GITHUB_OUTPUT
              ;;
            *)
              echo "‚ùå Invalid bundle_from_target: ${{ inputs.bundle_from_target }}"
              echo "   Valid values: dev, test, prod"
              exit 1
              ;;
          esac
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ steps.bundle-role.outputs.role-arn }}
          aws-region: ${{ vars.DOMAIN_REGION }}
          role-session-name: smus-bundle-session
      
      # Temporary: Register mwaaserverless-internal model until service is GA
      - name: Register AWS CLI model patch
        run: |
          aws configure add-model \
            --service-model file://src/smus_cicd/resources/mwaaserverless-2024-07-26.normal-edited-2.json \
            --service-name mwaaserverless-internal
      
      - name: Setup QuickSight dashboard (optional)
        if: ${{ inputs.quicksight_setup_script != '' }}
        env:
          DEV_DOMAIN_REGION: ${{ vars.DOMAIN_REGION }}
        run: |
          echo "üìä Setting up QuickSight dashboard..."
          python ${{ inputs.quicksight_setup_script }}
      
      - name: smus-cli describe (validate bundle source target)
        env:
          DOMAIN_REGION: ${{ vars.DOMAIN_REGION }}
          DEV_DOMAIN_REGION: ${{ vars.DOMAIN_REGION }}
          TEST_DOMAIN_REGION: ${{ vars.DOMAIN_REGION }}
          PROD_DOMAIN_REGION: ${{ vars.DOMAIN_REGION }}
        run: |
          echo "üîç Validating bundle source target: ${{ inputs.bundle_from_target }}"
          
          smus-cli describe --manifest ${{ inputs.manifest_path }} --targets ${{ inputs.bundle_from_target }} --connect
      
      - name: smus-cli bundle from ${{ inputs.bundle_from_target }}
        env:
          DOMAIN_REGION: ${{ vars.DOMAIN_REGION }}
          DEV_DOMAIN_REGION: ${{ vars.DOMAIN_REGION }}
          TEST_DOMAIN_REGION: ${{ vars.DOMAIN_REGION }}
          PROD_DOMAIN_REGION: ${{ vars.DOMAIN_REGION }}
        run: |
          echo "üîç DOMAIN_REGION: $DOMAIN_REGION"
          echo "üîç DEV_DOMAIN_REGION: $DEV_DOMAIN_REGION"
          echo "üîç TEST_DOMAIN_REGION: $TEST_DOMAIN_REGION"
          echo "üîç PROD_DOMAIN_REGION: $PROD_DOMAIN_REGION"
          echo "üì¶ Bundling from target: ${{ inputs.bundle_from_target }}"
          BUNDLE_DIR="${{ runner.temp }}/smus-bundles-${{ github.run_id }}"
          mkdir -p "$BUNDLE_DIR"
          echo "BUNDLE_DIR=$BUNDLE_DIR" >> $GITHUB_ENV
          
          smus-cli bundle \
            --manifest ${{ inputs.manifest_path }} \
            --targets ${{ inputs.bundle_from_target }} \
            --output-dir "$BUNDLE_DIR"
      
      - name: Upload bundle artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ github.event.repository.name }}-bundle
          path: ${{ env.BUNDLE_DIR }}/*.zip
          if-no-files-found: error

  validate:
    name: Validate Manifest
    runs-on: ubuntu-latest
    needs: bundle
    if: always()
    environment: test-aws-account
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python_version }}
      
      - name: Install SMUS CLI
        run: |
          
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN_TEST }}
          aws-region: ${{ vars.DOMAIN_REGION }}
          role-session-name: smus-validate-session
      
      - name: smus-cli describe (validate test target)
        env:
          DOMAIN_REGION: ${{ vars.DOMAIN_REGION }}
          TEST_DOMAIN_REGION: ${{ vars.DOMAIN_REGION }}
        run: |
          echo "üîç DOMAIN_REGION: $DOMAIN_REGION"
          echo "üîç TEST_DOMAIN_REGION: $TEST_DOMAIN_REGION"
          echo "üîç AWS_REGION: $AWS_REGION"
          
          smus-cli describe --manifest ${{ inputs.manifest_path }} --targets test --connect

  deploy-test:
    name: Deploy to Test
    runs-on: ubuntu-latest
    needs: validate
    environment: test-aws-account
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Download bundle artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ github.event.repository.name }}-bundle
          path: ${{ runner.temp }}/smus-bundles-${{ github.run_id }}
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python_version }}
      
      - name: Install SMUS CLI
        run: |
          
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN_TEST }}
          aws-region: ${{ vars.DOMAIN_REGION }}
          role-session-name: smus-deploy-test-session
      
      # Temporary: Register mwaaserverless-internal model until service is GA
      - name: Register AWS CLI model patch
        run: |
          aws configure add-model \
            --service-model file://src/smus_cicd/resources/mwaaserverless-2024-07-26.normal-edited-2.json \
            --service-name mwaaserverless-internal
      
      - name: Get AWS Account ID
        id: aws-account-test
        run: |
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          echo "account-id=$ACCOUNT_ID" >> $GITHUB_OUTPUT
          echo "‚úì AWS Account ID: $ACCOUNT_ID"
      
      - name: Setup MLflow Tracking Server
        id: mlflow-setup-test
        if: ${{ inputs.setup_mlflow }}
        run: |
          REGION="${{ vars.DOMAIN_REGION }}"
          ACCOUNT_ID="${{ steps.aws-account-test.outputs.account-id }}"
          STACK_NAME="smus-shared-resources"
          TRACKING_SERVER_NAME="smus-integration-mlflow-${REGION}"
          
          echo "üîç Checking for existing MLflow tracking server..."
          
          # Check if tracking server exists
          SERVER_EXISTS=$(aws sagemaker list-mlflow-tracking-servers \
            --region "$REGION" \
            --query "TrackingServerSummaries[?TrackingServerName=='$TRACKING_SERVER_NAME'].TrackingServerName" \
            --output text)
          
          if [ -n "$SERVER_EXISTS" ]; then
            echo "‚úÖ MLflow tracking server '$TRACKING_SERVER_NAME' already exists"
            echo "tracking-server-name=$TRACKING_SERVER_NAME" >> $GITHUB_OUTPUT
          else
            echo "üì¶ MLflow tracking server not found, deploying CloudFormation stack..."
            
            # Deploy CloudFormation stack
            aws cloudformation deploy \
              --template-file tests/scripts/setup/idc-based-domains/5-testing-infrastructure/testing-infrastructure/shared-resources-template.yaml \
              --stack-name "$STACK_NAME" \
              --parameter-overrides \
                S3BucketName="smus-mlflow-artifacts-${ACCOUNT_ID}-${REGION}" \
                TrackingServerName="$TRACKING_SERVER_NAME" \
                TrackingServerSize="Small" \
              --capabilities CAPABILITY_NAMED_IAM \
              --region "$REGION"
            
            # Get the tracking server ARN from stack outputs
            MLFLOW_ARN=$(aws cloudformation describe-stacks \
              --stack-name "$STACK_NAME" \
              --region "$REGION" \
              --query 'Stacks[0].Outputs[?OutputKey==`MLflowTrackingServerArn`].OutputValue' \
              --output text)
            
            echo "‚úÖ MLflow infrastructure deployed successfully"
            echo "   Tracking Server: $TRACKING_SERVER_NAME"
            echo "   ARN: $MLFLOW_ARN"
            echo "tracking-server-name=$TRACKING_SERVER_NAME" >> $GITHUB_OUTPUT
          fi
      
      - name: smus-cli describe (validate test target)
        env:
          DOMAIN_REGION: ${{ vars.DOMAIN_REGION }}
          TEST_DOMAIN_REGION: ${{ vars.DOMAIN_REGION }}
        run: |
          echo "üîç Validating test target: ${{ inputs.test_target }}"
          
          smus-cli describe --manifest ${{ inputs.manifest_path }} --targets ${{ inputs.test_target }} --connect
      
      - name: smus-cli deploy to test
        env:
          DOMAIN_REGION: ${{ vars.DOMAIN_REGION }}
          TEST_DOMAIN_REGION: ${{ vars.DOMAIN_REGION }}
          DEV_DOMAIN_REGION: ${{ vars.DOMAIN_REGION }}
          MLFLOW_TRACKING_SERVER_NAME: ${{ inputs.setup_mlflow && steps.mlflow-setup-test.outputs.tracking-server-name || '' }}
          STS_REGION: ${{ vars.DOMAIN_REGION }}
          STS_ACCOUNT_ID: ${{ steps.aws-account-test.outputs.account-id }}
          AWS_ACCOUNT_ID: ${{ steps.aws-account-test.outputs.account-id }}
        run: |
          echo "üîç DOMAIN_REGION: $DOMAIN_REGION"
          echo "üîç TEST_DOMAIN_REGION: $TEST_DOMAIN_REGION"
          BUNDLE_FILE=$(ls ${{ runner.temp }}/smus-bundles-${{ github.run_id }}/*.zip | head -1)
          echo "üîç Using bundle: $BUNDLE_FILE"
          
          smus-cli deploy \
            --manifest ${{ inputs.manifest_path }} \
            --targets ${{ inputs.test_target }} \
            --bundle-archive-path "$BUNDLE_FILE"
      
      - name: Download workflow output notebooks
        if: always()
        continue-on-error: true
        run: |
          
          
          # Extract workflow name from manifest path
          WORKFLOW_NAME=$(basename $(dirname ${{ inputs.manifest_path }}))
          FULL_WORKFLOW_NAME="IntegrationTest${WORKFLOW_NAME^}_test_marketing_*"
          
          echo "üì• Downloading outputs for workflow: $FULL_WORKFLOW_NAME"
          python3 tests/scripts/download_workflow_outputs_from_xcom.py \
            "$FULL_WORKFLOW_NAME" \
            --region ${{ vars.DOMAIN_REGION }} \
            --output-dir tests/test-outputs/notebooks || echo "‚ö†Ô∏è No outputs found or download failed"

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: [bundle, validate, deploy-test]
    # Run if tests are not skipped AND either deploy-test ran or was skipped
    if: ${{ !inputs.skip_tests && (success() || needs.deploy-test.result == 'skipped') }}
    environment: test-aws-account
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python_version }}
      
      - name: Install SMUS CLI
        run: |
          
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN_TEST }}
          aws-region: ${{ vars.DOMAIN_REGION }}
          role-session-name: smus-test-session
      
      # Temporary: Register mwaaserverless-internal model until service is GA
      - name: Register AWS CLI model patch
        run: |
          aws configure add-model \
            --service-model file://src/smus_cicd/resources/mwaaserverless-2024-07-26.normal-edited-2.json \
            --service-name mwaaserverless-internal
      
      - name: smus-cli test
        env:
          DOMAIN_REGION: ${{ vars.DOMAIN_REGION }}
          TEST_DOMAIN_REGION: ${{ vars.DOMAIN_REGION }}
        run: |
          echo "üîç DOMAIN_REGION: $DOMAIN_REGION"
          echo "üîç TEST_DOMAIN_REGION: $TEST_DOMAIN_REGION"
          
          smus-cli test \
            --manifest ${{ inputs.manifest_path }} \
            --targets ${{ inputs.test_target }}

  deploy-prod:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [bundle, deploy-test, test]
    # Deploy to prod if enabled AND (tests passed OR tests were skipped OR deploy-test was skipped)
    if: ${{ inputs.deploy_to_prod && (success() || inputs.skip_tests || needs.deploy-test.result == 'skipped') }}
    environment: prod-aws-account
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Download bundle artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ github.event.repository.name }}-bundle
          path: ${{ runner.temp }}/smus-bundles-${{ github.run_id }}
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python_version }}
      
      - name: Install SMUS CLI
        run: |
          
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN_PROD }}
          aws-region: ${{ vars.DOMAIN_REGION }}
          role-session-name: smus-deploy-prod-session
      
      # Temporary: Register mwaaserverless-internal model until service is GA
      - name: Register AWS CLI model patch
        run: |
          aws configure add-model \
            --service-model file://src/smus_cicd/resources/mwaaserverless-2024-07-26.normal-edited-2.json \
            --service-name mwaaserverless-internal
      
      - name: Get AWS Account ID
        id: aws-account-prod
        run: |
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          echo "account-id=$ACCOUNT_ID" >> $GITHUB_OUTPUT
          echo "‚úì AWS Account ID: $ACCOUNT_ID"
      
      - name: Setup MLflow Tracking Server
        id: mlflow-setup-prod
        if: ${{ inputs.setup_mlflow }}
        run: |
          REGION="${{ vars.DOMAIN_REGION }}"
          ACCOUNT_ID="${{ steps.aws-account-prod.outputs.account-id }}"
          STACK_NAME="smus-shared-resources"
          TRACKING_SERVER_NAME="smus-integration-mlflow-${REGION}"
          
          echo "üîç Checking for existing MLflow tracking server..."
          
          # Check if tracking server exists
          SERVER_EXISTS=$(aws sagemaker list-mlflow-tracking-servers \
            --region "$REGION" \
            --query "TrackingServerSummaries[?TrackingServerName=='$TRACKING_SERVER_NAME'].TrackingServerName" \
            --output text)
          
          if [ -n "$SERVER_EXISTS" ]; then
            echo "‚úÖ MLflow tracking server '$TRACKING_SERVER_NAME' already exists"
            echo "tracking-server-name=$TRACKING_SERVER_NAME" >> $GITHUB_OUTPUT
          else
            echo "üì¶ MLflow tracking server not found, deploying CloudFormation stack..."
            
            # Deploy CloudFormation stack
            aws cloudformation deploy \
              --template-file tests/scripts/setup/idc-based-domains/5-testing-infrastructure/testing-infrastructure/shared-resources-template.yaml \
              --stack-name "$STACK_NAME" \
              --parameter-overrides \
                S3BucketName="smus-mlflow-artifacts-${ACCOUNT_ID}-${REGION}" \
                TrackingServerName="$TRACKING_SERVER_NAME" \
                TrackingServerSize="Small" \
              --capabilities CAPABILITY_NAMED_IAM \
              --region "$REGION"
            
            # Get the tracking server ARN from stack outputs
            MLFLOW_ARN=$(aws cloudformation describe-stacks \
              --stack-name "$STACK_NAME" \
              --region "$REGION" \
              --query 'Stacks[0].Outputs[?OutputKey==`MLflowTrackingServerArn`].OutputValue' \
              --output text)
            
            echo "‚úÖ MLflow infrastructure deployed successfully"
            echo "   Tracking Server: $TRACKING_SERVER_NAME"
            echo "   ARN: $MLFLOW_ARN"
            echo "tracking-server-name=$TRACKING_SERVER_NAME" >> $GITHUB_OUTPUT
          fi
      
      - name: smus-cli describe (validate prod target)
        env:
          DOMAIN_REGION: ${{ vars.DOMAIN_REGION }}
          PROD_DOMAIN_REGION: ${{ vars.DOMAIN_REGION }}
        run: |
          echo "üîç Validating prod target: ${{ inputs.prod_target }}"
          
          smus-cli describe --manifest ${{ inputs.manifest_path }} --targets ${{ inputs.prod_target }} --connect
      
      - name: smus-cli deploy to production
        env:
          DOMAIN_REGION: ${{ vars.DOMAIN_REGION }}
          PROD_DOMAIN_REGION: ${{ vars.DOMAIN_REGION }}
          DEV_DOMAIN_REGION: ${{ vars.DOMAIN_REGION }}
          MLFLOW_TRACKING_SERVER_NAME: ${{ inputs.setup_mlflow && steps.mlflow-setup-prod.outputs.tracking-server-name || '' }}
          STS_REGION: ${{ vars.DOMAIN_REGION }}
          STS_ACCOUNT_ID: ${{ steps.aws-account-prod.outputs.account-id }}
          AWS_ACCOUNT_ID: ${{ steps.aws-account-prod.outputs.account-id }}
        run: |
          echo "üîç DOMAIN_REGION: $DOMAIN_REGION"
          echo "üîç PROD_DOMAIN_REGION: $PROD_DOMAIN_REGION"
          BUNDLE_FILE=$(ls ${{ runner.temp }}/smus-bundles-${{ github.run_id }}/*.zip | head -1)
          echo "üîç Using bundle: $BUNDLE_FILE"
          
          smus-cli deploy \
            --manifest ${{ inputs.manifest_path }} \
            --targets ${{ inputs.prod_target }} \
            --bundle-archive-path "$BUNDLE_FILE"
